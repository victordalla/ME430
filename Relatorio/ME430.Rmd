---
output: 
  pdf_document:
    template: template.tex 
    number_sections: true
bibliography: bibliography.bib
papersize: a4paper
fontsize: 11pt
documentclass: article
geometry: margin=2cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE,
                      hide = TRUE,
                      tidy.opts = list(width.cutoff = 60),
                      tidy = TRUE)
options(OutDec = ",", 
        digits = 4, 
        knitr.table.format = "latex", 
        xtable.comment = FALSE)
```


\begin{titlepage} 

\begin{center} 
{\large Universidade Estadual de Campinas}\\[0.2cm] 
{\large Instituto de Matemática, Estatística e Computação Científica}\\[0.2cm] 
{\large Departamento de Estatística - ME430}\\[4cm]

{\bf \huge Trabalho de ME430}\\[6cm]

{\large Grupo}\\[0.2cm]
{\large Bragantini, J. RA170844\\Nogueira, N. RA204186\\Betini, L. RA201357\\Cunha, V. RA206493}\\[0.2cm]
{\large Prof. Dr. Caio Azevedo}\\[6cm]

{\large Campinas}\\[0.2cm]
{\large 2018}
\end{center}

\end{titlepage}


# Questão 2 da Lista IV {-}

# Introdução

```{r lib}
library(readr)
library(dplyr)
library(tidyr)
library(magrittr)
library(fastkendall)
library(psych)
library(purrr)
```

```{r leitura}
questionario <- read_csv2('../dados/2017_quest.txt')
questionario$APROVA1 <- ifelse(is.na(questionario$APROVA1), 0, 1)
colnames(questionario)[1] <- 'EMPCT'

conv_matr <- read_csv2('../dados/ConvocadosMatriculados.csv')
conv_matr$CONVOCADO <- ifelse(is.na(conv_matr$CONVOCADO), 0, 1)
conv_matr$MATRICULADO <- ifelse(is.na(conv_matr$MATRICULADO), 0, 1)

fase1 <- read_csv2('../dados/Fase1TipoQ.csv', 
                   col_types = cols_only('EMPCT' = col_integer(), 
                                         'TOTAL' = col_integer()))

opcoes <- read_csv2('../dados/Opcoes.csv')

# DADOS DUPLICADOS 
conv_matr %<>% subset(!duplicated(conv_matr$EMPCT))

N <- nrow(fase1)
```

Este trabalho consiste na aplicação de técnicas aprendidas na disciplina ME430 - Técnicas de Amostragem - em um conjunto de dados da COMVEST. Esse conjunto de dados possui informações de `r N` candidatos ao vestibular 2017 da UNICAMP e seus desempenhos nele. O objetivo é estimar i) a média da pontuação total de cada cadiadato, ii) a proporção de candidatos que cursaram todo o ensino médio em escola pública e iii) o total de quartos nas casas de todos os candidatos. 

A Seção \ref{s.descritiva} contém análises descritivas a nível populacional e obtidas por meio de amostras pilotos. A Seção \ref{s.inferencia} apresenta análises inferenciais, estimadores pontuais e intervalos de confiança dos parâmetros de interesse. Essas duas seções são dividas em três subseções cada, uma para cada parâmetro: *Média*, *Proporção* e *Total*, que se referem, respectivamente, aos parâmetros i), ii) e iii).

A principal ferramenta usada foi a linguagem de programação R. Nela, foram utilizados os pacotes: *readr* para leitura de dados; *dplyr*, *magrittr* e *tidyr* para manipulação de dados, *fastkendall* para computar a Correlação de Kendall em $O(n \log(n))$ (o pacote padrão do R calcula em $O(n^2)$) e *psych* para o cômputo da Correlação Policórica. Os códigos produzidos estão disponíveis em https://github.com/victordalla/ME430.


# Análise Descritiva
\label{s.descritiva}

Tratamos as análises realizas abaixos como indepentes visto que o âmbito de cada análise são diferentes.


## Média

```{r mu-dados}
mu_dados <- fase1 %>% left_join(questionario)

# 1: NA, 2: 5 SM ou menos, 3: entre 5 e 10 SM, 4: mais de 10 SM
mu_dados$Q14[mu_dados$Q14 == 0] <- 1
mu_dados$Q14[mu_dados$Q14 < 5 & mu_dados$Q14 != 1] <- 2
mu_dados$Q14[mu_dados$Q14 == 5 | mu_dados$Q14 == 6] <- 3
mu_dados$Q14[mu_dados$Q14 > 6] <- 4
```


```{r mu-piloto}

mu_N_h <- mu_dados %>% group_by(Q14) %>% summarise(N_h = n()) %>% .$N_h
mu_W_h <- mu_N_h / N
mu_H <- length(mu_N_h)

mu_n_piloto <- 200

mu_estrato_piloto <- data.frame(Q14 = c(1, 2, 3, 4),
                                n_h = c(ceiling(mu_W_h * mu_n_piloto)))

mu_n_piloto <- sum(mu_estrato_piloto$n_h)

mu_amostra_piloto <- mu_dados %>% nest(-Q14) %>% 
    left_join(mu_estrato_piloto, by = "Q14") %>% 
    mutate(amostra = map2(data, n_h, sample_n)) %>% 
    unnest(amostra)

mu_estat_piloto <- mu_amostra_piloto %>% group_by(Q14) %>%
    summarise(n_h = n(),
              mu_hat_h = mean(TOTAL),
              s2hat_h = var(TOTAL))

mu_estat_piloto$varhat_h <- ((1 - mu_estat_piloto$n_h/mu_N_h) * 
                                 mu_estat_piloto$s2hat_h/mu_estat_piloto$n_h)

mu_hat_piloto <- sum(mu_W_h * mu_estat_piloto$mu_hat_h)
mu_s2hat_d_piloto <- sum(mu_W_h * mu_estat_piloto$s2hat_h)
mu_s2hat_e_piloto <- sum(mu_W_h * (mu_estat_piloto$mu_hat_h - mu_hat_piloto)^2)
mu_s2hat_total_piloto <- mu_s2hat_d_piloto + mu_s2hat_e_piloto

```


```{r mu-tam-amostral}
mu_delta <- 1
mu_gamma <- 0.95
mu_z_gamma <- qnorm((1 + mu_gamma) / 2)

# tamanhos amostrais
mu_n_ASSs <- ceiling(1 / ((mu_delta^2 / (mu_z_gamma^2 * mu_s2hat_total_piloto)) + (1/N)))

mu_n <- ceiling(1 / ((mu_delta^2 / (mu_z_gamma^2 *sum(mu_W_h * mu_estat_piloto$s2hat_h))) + (1/N))) 

mu_n_h <- ceiling(mu_n * mu_N_h * sqrt(mu_estat_piloto$s2hat_h) /
                      sum(mu_N_h * sqrt(mu_estat_piloto$s2hat_h)))

mu_n <- sum(mu_n_h)
```

Inicialmente, para estimar $\mu$, a pontuação média de todos os candidatos na 1ª fase, foi coletada uma amostra piloto de tamanho `r n_piloto` sob uma amostragem estratificada (AE) com $H = `r H`$ estratos, especificados a seguir, a fim de determinar o tamanho amostral e o plano amostral mais adequado. Para isso, foi estimado a variância $\sigma_{\mu}^2 = \frac{1}{N} \sum_{i=1}^N y_i$ da pontuação e a variância nos estratos $\sigma_{\mu h}^2 = \frac{1}{N_h} \sum_{i=1}^{N_h} y_{ih}$, onde $N = `r N`$ é o número de candidatos, $N_h$ é o tamanho populacional do h-ésimo estrato, $y_i$ é a pontuação do i-ésimo candiadato e $y_{ih}$ é a pontuação do i-ésimo candidato no h-ésimo estrato. A alocação dos estratos foi feita segundo alocação proporcional (AP). Nesse tipo de alocação, o tamanho amostral do h-ésimo estrato é $n_h = n \frac{N_h}{N}$.

Os estratos escolhidos foram as respostas agrupadas da Questão 14 no questionário que cada candidato deveria responder. Essa questão é como segue: "Somando a sua renda com a renda das pessoas que moram com você, quanto é, aproximadamente, a renda familiar mensal? O valor do salário mínimo (SM) é de R$ 724,00". As respostas agrupadas determinam os seguintes estratos: 1 - dados faltantes, 2 - até 5 SM, 3 - entre 5 e 10 SM e 4 - mais que 10 SM.

A amostra piloto resultou em uma estimativa de $\hat{\sigma_{\mu}^2} = \hat{\sigma_d^2} + \hat{\sigma_e^2} = `r var_d + var_e`$ **(HELP WANTED)** para a variância $\sigma_{\mu}^2$, onde $\hat{\sigma_d^2} = \sum_{i=1}^H \frac{N_h}{N}\hat{\sigma_h^2}$ é a variância estimada no h-ésimo estrato e $\hat{\sigma_e^2} = \sum_{i=1}^H \frac{N_h}{N}(\hat{\mu}_h-\mu)^2$ é a variância estimada das médias dos estratos. 
De posse dessa informação, para realizar AE com AP e erro de estimativa $\delta = `r delta`$, é preciso um tamanho de amostra $n$ de pelo menos $n \geq \frac{z_{`r gamma`}^2}{\delta^2} \sum_{i=1}^H\frac{N_h}{N} \hat{\sigma^2}$ **(OU SERIA S^2 AQUI?)** para garantir que $P(|\mu - \hat{\mu}| \leq \delta) \geq `r gamma`$ \cite{bolfarine2005elementos}, onde $z_{`r gamma`}$ é o `r gamma`-quantil da normal padrão. Portanto, para os dados coletados, são necessárias pelo menos `r n_AE_AP` unidades amostrais.

Por outro lado, uma amostragem aleatória simples sem reposição (AASs) requer $\Big(\frac{\delta^2}{\hat{s^2}z_{`r gamma`}} + \frac{1}{N}\Big)^{-1}$ unidades amostrais para garantir que $P(|\mu - \hat{\mu}| \leq \delta) \geq `r gamma`$ \cite{bolfarine2005elementos}, onde $s_{\mu}^2 = \frac{n\sigma^2}{n-1}$. Para os dados observados, esse plano amostral precisa de `r n_AASs` unidades amostrais, número maior que no caso AE com AP. Portanto, é mais vantajoso realizar AE com AP. 

É possível tornar a amostragem ainda mais robusta, utilizando a alocação ótima de Neyman (AON), que minimiza a variância da estimativa $\hat{\mu} = \sum$  para $\mu$ quando o custo de amostragem é homogêneo entre os estratos. Usando AON, temos que $n_h = n \frac{N_h\sigma_h}{\sum_{i=1}^HN_h\sigma_h}$ \cite{bolfarine2005elementos}. Como $\sigma_h$ não são valores conhecidos, foi usado $\hat{\sigma_h^2}$. As informações obtidas da amostra piloto e referentes à amostragem AE com AON estão resumidas na Tabela \ref{tab:resumo-media}. Observe que $n = `r n`$ tem `r n-n_AE_AP` unidades a mais sob AON, pelo fato de ter sido pego o menor inteiro maior que a expressão que determina $n_h$.

\begin{table}[!h]
\centering
\caption{Informações de cada estrato $h$: $N_h$ - número de cadidatos no estrato, $\hat{\sigma_h^2}$ - variância no estrato estimada na amostra piloto, $n_h$ - tamanho amostral do estrato segundo AON.}
\label{tab:resumo-media}
\fontsize{11}{13}\selectfont

\begin{tabular}{l|lll}
$h$ & $N_h$ & $\hat{\sigma_h^2}$ & $n_h$ \\
\hline
1 & `r N_h[1]` & `r stats$var_h[1]` & `r n_h[1]` \\
2 & `r N_h[2]` & `r stats$var_h[2]` & `r n_h[2]` \\
3 & `r N_h[3]` & `r stats$var_h[3]` & `r n_h[3]` \\
4 & `r N_h[4]` & `r stats$var_h[4]` & `r n_h[4]` \\
\end{tabular}
\end{table}


## Proporção
\label{ss.descr.prop}

```{r prop-descritiva}
invisible(capture.output(cor_fund1_fund2 <- polychoric(table(questionario$Q2, questionario$Q3))$rho))
```

```{r prop-piloto}
prop_n_piloto <- 200
prop_amostra_piloto <- sample_n(questionario, prop_n_piloto)

# Proporcao de alunos de escola pública
pub <- questionario[questionario$Q3 == 1, ]$EMPCT
priv <- questionario[questionario$Q3 != 1, ]$EMPCT

prop_N_h <- c(length(pub), length(priv))
prop_W_h <- prop_N_h / N
prop_H <- 2 # quantidade de estratos

# Amostra piloto 
prop_n_h_piloto <- ceiling(prop_W_h * prop_n_piloto) # estrato proporcional

prop_n_piloto <- sum(prop_n_h_piloto)

prop_amostra_pil_h1 <- sample_n(questionario %>% filter(EMPCT %in% pub), prop_n_h_piloto[1])
prop_amostra_pil_h2 <- sample_n(questionario %>% filter(EMPCT %in% priv), prop_n_h_piloto[2])

prop_phat_h_piloto <- c(sum(prop_amostra_pil_h1$Q4 == 1) / nrow(prop_amostra_pil_h1),
                      sum(prop_amostra_pil_h2$Q4 == 1) / nrow(prop_amostra_pil_h2))

prop_s2hat_piloto <- prop_n_h_piloto / (prop_n_h_piloto - 1) * prop_phat_h_piloto * (1 - prop_phat_h_piloto)

varhat_phat_piloto <- (1 - prop_n_h_piloto/N) * prop_s2hat_piloto / prop_n_h_piloto

prop_phat_piloto <- sum(prop_phat_h_piloto * prop_W_h)
prop_s2hat_e_piloto <- sum(prop_W_h * (prop_phat_h_piloto - prop_phat_piloto)^2)
prop_s2hat_d_piloto <- sum(prop_W_h * prop_s2hat_piloto)
```

```{r prop-tam-amostral}
prop_delta <- 0.01
prop_gamma <- 0.95
prop_z_gamma <- qnorm((1 + prop_gamma) / 2)
prop_n <- ceiling(1 / (prop_delta^2/(prop_z_gamma^2 * sum(prop_W_h * prop_s2hat_piloto)) + 1/N))

prop_n_h <- ceiling(prop_n * prop_N_h * sqrt(prop_s2hat_piloto) / sum(prop_N_h * sqrt(prop_s2hat_piloto)))

prop_n <- sum(prop_n_h)
```


A nível populacional, observa-se que existe uma correlação de `r cor_fund1_fund2` entre o setor (público ou privado) da escola de um candidato em um nível (Ensino Fundamental 1, Ensino Fundalmental 2 e Ensino Médio) ao nível subsequente. De encontro a essa informação, também se observa que alunos que estudaram o Ensino Fundamental 1 completamente em instituições públicas frequentaram o Ensino Fundamental 2 público numa proporção maior dos restantes dos indivíduos **APRESENTAR DADOS QUE CORROBOREM AFIRMAÇÂO**.

Assim dividiremos nossa população em dois estratos: 1 - candidatos que cursaram o Ensino Fundamental 1 por completo em escolas públicas e 2 - candidatos restantes.


Sob essa estratificação, selecionamos uma amostra piloto de tamanho `r prop_n_piloto`, onde cada estrato foi amostrado com um tamanho proporcional a sua população e verificamos se o comportamento de se manter no mesmo setor do ensino quando se passa do Ensino Fundamental 2 para o Ensino Médio é similar ao do observado na Subseção \ref{ss.descr.prop}.

Na Tabela \ref{tab:piloto-prop} apresentamos as estatísticas da nossa amostra piloto. Utilizando essas informações, vemos que a variância dentro dos estratos, $\hat{s_d^2} = `r prop_s2hat_d_piloto`$ é consideravelmente menor que a estimativa da variância da amostra, $\hat{s^2} = \hat{s_d^2} + \hat{s_d^2} = `r prop_s2hat_d_piloto + prop_s2hat_e_piloto`$.

Com as estatísticas obtidas da amostra piloto estabelecemos nossa margem de erro desejada, $\delta = `r prop_delta`$, e nosso intervalo de confiança desejado, $\gamma = `r prop_gamma`$, assim conforme a Equação \ref{eq:n-prop-estrat} apresentada no Apêndice, obtemos o tamanho amostral $n = `r prop_n`$. 


\begin{table}[!h]
\centering
\caption{Informações de cada estrato $h$ para amostra piloto: $\hat{p}_h$ - proporção de canditatos estudaram o ensino medio completo em escolas públicas, $N_h$ - número de cadidatos no estrato, $\hat{s^2_h}$ - variância no estrato estimada na amostra piloto, $n_h$ - tamanho amostral do estrato.}
\label{tab:piloto-prop}
\fontsize{11}{13}\selectfont

\begin{tabular}{l|lll}
$h$ & $N_h$ & $\hat{p}_h$ & $\hat{s_h^2}$ \\
\hline

1 & `r prop_N_h[1]` & `r prop_phat_h_piloto[1]` & `r prop_s2hat_piloto[1]` \\
2 & `r prop_N_h[2]` & `r prop_phat_h_piloto[2]` & `r prop_s2hat_piloto[2]` \\
\end{tabular}
\end{table}



## Total

```{r total-descritiva}

# Conferir isso, adicionar isso na analise descritiva que 
# 0 é igual a não resposta e 5 é igual a zero quartos 
questionario$Q32C[questionario$Q32C == 0] <- NA
questionario$Q32C[questionario$Q32C == 5] <- 0

# n_piloto <- 200
# piloto_total <- sample_n(questionario, n_piloto)

# piloto_total %>% ggplot(aes(Q32D, Q32C, alpha = 0.2)) + 
#     geom_jitter() + xlab("# Banheiros") + ylab("# Quartos")

# Deve ser maior que 0.6
# UTILIZAR PACOTE PSYCH QUE O CAIO FALOU NA AULA
# piloto_total %$% fastkendall(.$Q32D, .$Q32C)
# http://www.john-uebersax.com/stat/tetra.htm
# corr <- piloto_total %$% polychoric(table(.$Q15, .$Q32C))$rho

# Deve ser entre 0.5 e 1.3
# tmp <- (sd(piloto_total$Q15) / mean(piloto_total$Q15)) / (sd(piloto_total$Q32C)/mean(piloto_total$Q32C))
# 
# Deve ser menor que rho(x, y)
# tmp <- (sd(piloto_total$Q15) / mean(piloto_total$Q15)) / (2 * sd(piloto_total$Q32C)/mean(piloto_total$Q32C))

```

```{r total-piloto}
tau_n_piloto <- 200

tau_amostra_piloto <- sample_n(questionario, tau_n_piloto)
tau_amostra_piloto_sem_na <- tau_amostra_piloto %>% filter(!is.na(Q32C))

tau_n_piloto_sem_na <- nrow(tau_amostra_piloto_sem_na)

tau_prop_na <- 1 - (tau_n_piloto_sem_na/tau_n_piloto)

tau_hat_piloto <- N * mean(tau_amostra_piloto_sem_na$Q32C)
tau_s2hat_piloto <- var(tau_amostra_piloto_sem_na$Q32C)
tau_varhat_piloto <- N^2 * (1 - tau_n_piloto_sem_na/N) * tau_s2hat_piloto / tau_n_piloto_sem_na
```

```{r total-tam-amostral}
tau_delta = 3500
tau_gamma <- 0.95
tau_z_t <- qnorm((1 + tau_gamma) / 2)

tau_n <- 1 / ((tau_delta^2/(N^2*tau_s2hat_piloto^2*tau_z_t^2)) + 1/N)
tau_n <- ceiling(tau_n * (1 + tau_prop_na))
```

No banco de dados há informações sobre eletrônicos domésticos, cômodos das casas e da estrutura familiar dos inscritos no vestibular da COMVEST. Para estimar o total de quartos de uma casa, foi verificado se existe alguma ligação entre a quantidade de banheiro, número de pessoas dependentes da mesma renda familiar e quantidade de televisões na casa com o total de quartos da casa. Essas variáveis foram selecionados supondo-se que normalmente uma casa com muitos quartos possui mais banheiros, mais dependentes e a possibilidade de haverem televisões em cômodos diferentes da casa.

<!-- 
################################################################################
-->

# Análise Inferencial
\label{s.inferencia}

## Média


```{r mu-amostra}
mu_estrato <- data.frame(Q14 = c(1, 2, 3, 4),
                         n_h = mu_n_h)

mu_amostra <- mu_dados %>% nest(-Q14) %>% 
    left_join(mu_estrato, by = "Q14") %>% 
    mutate(amostra = map2(data, n_h, sample_n)) %>% 
    unnest(amostra)

mu_estat <- mu_amostra %>% group_by(Q14) %>%
    summarise(n_h = n(),
              mu_hat_h = mean(TOTAL),
              s2hat_h = var(TOTAL))

# TODO divide por n_h ou nzinho?
mu_estat$varhat_h <- ((1 - mu_estat$n_h/mu_N_h) * 
                          mu_estat$s2hat_h/mu_estat$n_h)

mu_hat <- sum(mu_W_h * mu_estat$mu_hat_h)
# TODO daqui para baixo está com formula de estrato proporcional e foi utilizado alocacao otima
mu_s2hat_d <- sum(mu_W_h * mu_estat$s2hat_h)
mu_s2hat_e <- sum(mu_W_h * (mu_estat$mu_hat_h - mu_hat)^2)
mu_s2hat_total <- mu_s2hat_d + mu_s2hat_e
mu_varhat_mu <- sum(mu_W_h * (1 - mu_estat$n_h/mu_N_h) * mu_estat$s2hat_h / mu_estat$n_h)
# TODO end
```

```{r mu-int-conf}
mu_z_alpha <- qnorm((1 + mu_gamma)/2)
mu_ic <- c(mu_hat - mu_z_alpha * sqrt(mu_varhat_mu),
           mu_hat + mu_z_alpha * sqrt(mu_varhat_mu))
```


## Proporção

```{r prop-amostra}
# Amostragem final
prop_amostra_h1 <- sample_n(questionario %>% filter(EMPCT %in% pub), prop_n_h[1])
prop_amostra_h2 <- sample_n(questionario %>% filter(EMPCT %in% priv), prop_n_h[2])

prop_phat_h <- c(sum(prop_amostra_h1$Q4 == 1) / nrow(prop_amostra_h1),
            sum(prop_amostra_h2$Q4 == 1) / nrow(prop_amostra_h2))

prop_phat <- sum(prop_W_h * prop_phat_h)

prop_s2hat <- prop_n_h / (prop_n_h - 1) * prop_phat_h * (1 - prop_phat_h)

prop_varhat_phat_h <- (1 - prop_n_h/N) * prop_s2hat / prop_n_h

# http://www.ime.unicamp.br/~cnaber/aula_AE%20P3%20Amost%202S%202018.pdf 
# Slide 13
prop_varhat_phat <- sum( (1 - prop_n_h/prop_N_h) * prop_W_h^2 * 
                             prop_phat_h * (1 - prop_phat_h) / (prop_n_h - 1))

prop_s2hat_e <- sum(prop_W_h * (prop_phat_h - prop_phat)^2)
prop_s2hat_d <- sum(prop_W_h * prop_phat)
```

```{r prop-int-conf}
# http://www.ime.unicamp.br/~cnaber/aula_AE%20P3%20Amost%202S%202018.pdf 
# Slide 18
# utilizando z_alpha segundo formula do z_gamma no slide 19

prop_z_alpha <- qnorm((1 + prop_gamma)/2)
prop_ic <- c(prop_phat - prop_z_alpha * sqrt(prop_varhat_phat),
             prop_phat + prop_z_alpha * sqrt(prop_varhat_phat))
```

Uma vez definido o tamanho da amostra definimos o tamanho de cada estrato utilizando a Alocação Ótima de Neyman, Equação \ref{eq:aon-estrat} vide Apêndice, dado isso obtemos nossa amostra, **... continuar blah blah blah**

\begin{table}[!h]
\centering
\caption{Informações de cada estrato $h$: $\hat{p}_h$ - proporção de canditatos estudaram o ensino medio completo em escolas públicas, $N_h$ - número de cadidatos no estrato, $\hat{s^2_h}$ - variância no estrato estimada na amostra piloto, $n_h$ - tamanho amostral do estrato.}
\label{tab:piloto-prop}
\fontsize{11}{13}\selectfont

\begin{tabular}{l|lllll}
$h$ & $N_h$ & $\hat{p}_h$ & $\hat{Var(\hat{p_h})}$ & $\hat{s_h^2}$  & $n_h$ \\
\hline

1 & `r prop_N_h[1]` & `r prop_phat_h[1]` & `r format(prop_varhat_phat_h[1], digits=4)` & `r prop_s2hat[1]` & `r prop_n_h[1]` \\
2 & `r prop_N_h[2]` & `r prop_phat_h[2]` & `r format(prop_varhat_phat_h[2], digits=4)` & `r prop_s2hat[2]` & `r prop_n_h[2]` \\
\end{tabular}
\end{table}

## Total

```{r total-amostra}
tau_amostra <- sample_n(questionario, tau_n)
tau_amostra_sem_na <- tau_amostra %>% filter(!is.na(Q32C))
tau_n_sem_na <- nrow(tau_amostra_sem_na)

tau_hat <- N * mean(tau_amostra_sem_na$Q32C)
tau_s2hat <- var(tau_amostra_sem_na$Q32C)
tau_varhat <- N^2 * (1 - tau_n_sem_na / N) * tau_s2hat / tau_n_sem_na
```

```{r total-int-conf}
tau_z_alpha <- qnorm((1 + tau_gamma)/2)

tau_ic <- c(tau_hat - tau_z_alpha * sqrt(tau_varhat),
            tau_hat + tau_z_alpha * sqrt(tau_varhat))
```

\begin{table}[!h]
\centering
\caption{Blah blah balh}
\label{tab:total}
\fontsize{11}{13}\selectfont

\begin{tabular}{lllll}
$N$ & $n$ & $\hat \tau$ & $\hat{Var(\hat \tau)}$ & $\hat{s^2}$ \\
\hline
`r N` & `r tau_n_sem_na` & `r format(tau_hat, digits=4)` & `r format(tau_varhat, digits=4)` & `r tau_s2hat`
\end{tabular}
\end{table}

# Conclusões

\bibliographystyle{plain}
\bibliography{bibliography}

# Apêndice {-}
\label{apendice}

Este Apêndice apresenta expressões e estimadores usados no trabalho. A subseção *Parâmetros populacionais* apresenta as expressões que definem os parâmetros pupolacionais que aparecem no corpo do texto de uma população de tamanho $N$ de valores $y_1, ..., y_N$. A subseção *Estimadores* apresenta os estimadores usados. Finalmente, a subseção *Tamanho amostral e alocação* apresenta as expressões que definem os tamanhos amostrais para alguns planos amostrais e, no caso da Amostragem Estratificada com $H$ estratos, cada um de tamanho $N_h$ e onde $y_{hi}$ é o valor do i-ésimo elemento do h-ésimo estrato, os tamanhos de cada estrato segundo algumas alocações.

## Parâmetros populacionais {-}

De modo geral, temos os seguintes parâmetros: 
total $\tau = \sum_{i=1}^N y_i ~\refstepcounter{equation}(\theequation) \label{eq:total}$, 
média $\mu = \frac{1}{N} \sum_{i=1}^N y_i ~\refstepcounter{equation}(\theequation) \label{eq:media}$, 
variância $\sigma^2 = \frac{1}{N} \sum_{i=1}^N (y_i - \mu)^2 ~\refstepcounter{equation}(\theequation) \label{eq:var}$ 
e $s^2 = \frac{1}{N-1} \sum_{i=1}^N (y_i - \mu)^2 ~\refstepcounter{equation}(\theequation) \label{eq:s}$.

Sob Amostragem Estratificada, temos que o total do h-ésimo estrato é $\tau_h = \sum_{i=1}^{N_h} y_{hi} ~\refstepcounter{equation}(\theequation) \label{eq:media-h}$, 
a média do h-ésimo estrato é $\mu_h = \frac{1}{N_h} \sum_{i=1}^{N_h} y_{hi} ~\refstepcounter{equation}(\theequation) \label{eq:media-h}$, 
as variâncias do h-ésimo estrato são $\sigma_h = \frac{1}{N_h} \sum_{i=1}^{N_h} (y_{hi} - \mu_h)^2 ~\refstepcounter{equation}(\theequation) \label{eq:sigma-h}$ 
e $s_h = \frac{1}{N_h-1} \sum_{i=1}^{N_h} (y_{hi} - \mu_h)^2 ~\refstepcounter{equation}(\theequation) \label{eq:s-h}$. 

Assim, sendo $W_h = \frac{N_h}{N}$, temos que 
$\tau = \sum_{i=1}^H \tau_h ~\refstepcounter{equation}(\theequation) \label{eq:total-es}$, 
$\mu = \sum_{i=1}^H W_h \mu_h ~\refstepcounter{equation}(\theequation) \label{eq:media-es}$, 
$\sigma^2 = \sigma_d^2 + \sigma_e^2 ~\refstepcounter{equation}(\theequation) \label{eq:var-es}$ 
e $s^2 = s_d^2 + s_e^2 ~\refstepcounter{equation}(\theequation) \label{eq:s-es}$, 
onde $\sigma_d^2 = \sum_{i=1}^H W_h \sigma_h^2 ~\refstepcounter{equation}(\theequation) \label{eq:sigma-d}$, 
$\sigma_e^2 = \sum_{i=1}^H W_h (\mu_h - \mu)^2 ~\refstepcounter{equation}(\theequation) \label{eq:sigma-e}$, 
$s_d^2 = \sum_{i=1}^H \frac{N_h-1}{N-1} s_h^2 ~\refstepcounter{equation}(\theequation) \label{eq:s-d}$, 
$s_e^2 = \sum_{i=1}^H \frac{N_h}{N-1} (\mu_h - \mu)^2 ~\refstepcounter{equation}(\theequation) \label{eq:s-e}$.

Se $y_i$, $i = 1, ..., N$, assumem somente valores 0 ou 1, 
então $p = \mu ~\refstepcounter{equation}(\theequation) \label{eq:p}$ é uma proporção, 
$\sigma^2 = p(1-p) ~\refstepcounter{equation}(\theequation) \label{eq:sigma-p}$ 
e $s^2 = \frac{N}{N-1} p(1-p) ~\refstepcounter{equation}(\theequation) \label{eq:s-p}$. E, no caso da Amostragem Estratificada, 
$p_h = \mu_h ~\refstepcounter{equation}(\theequation) \label{eq:p-h}$ é a proporção do h-ésimo estrato, 
$\sigma_h^2 = p_h(1-p_h) ~\refstepcounter{equation}(\theequation) \label{eq:sigma-p-h}$ 
e $s_h^2 = \frac{N}{N-1} \sigma_h^2 ~\refstepcounter{equation}(\theequation) \label{eq:s-p-h}$.


## Estimadores {-}

Os seguintes estimadores se referem a uma amostra de tamanho $n$.

Sob Amostragem Simples sem reposição:
$\hat{\mu} = \frac{1}{n} \sum_{i=1}^n Y_i$
$\hat{\tau} = N\hat{\mu}$ e 
$\hat{s}^2 = \frac{1}{n-1} \sum_{i=1}^n (Y_i - \hat{\mu})^2$.

Sob Amostragem Estratificada: 
$\hat{\mu}_h = \frac{1}{N_h} \sum_{i=1}^{N_h} Y_{ih}$, 
$\hat{\mu} = \sum_{i=h}^H W_h \hat{\mu}_h$, 
$\hat{s}^2$ **QUAL???**. No caso em que $y_i$, $i = 1, ..., N$, assumem somente valores 0 ou 1, $\hat{p}$, $\hat{p}_h$, $\hat{s}^2$ e $\hat{s}_h^2$ têm a mesma forma que $\hat{\mu}$, $\hat{\mu}_h$, $\hat{\mu}^2$ e $\hat{\mu}_h^2$, respectivamente $~\refstepcounter{equation}(\theequation) \label{eq:p-hat}$.


## Tamanho amostral e alocação {-}

Segundo Bolfarine *et al.* \cite{bolfarine2005elementos}, as seguintes expressões para $n$ garantem que $P(|\mu - \hat{\mu}| \leq \delta) \geq \gamma$, onde $z_{\gamma}$ é o $(\frac{1-\gamma}{2})$-quantil da normal padrão.

Sob Amostragem Simples sem reposição: 
\begin{equation} \label{eq:n-aass}
n = \Big\lceil \Big( \frac{\delta^2}{\hat{s^2}z_{`r gamma`}} + \frac{1}{N} \Big)^{-1} \Big\rceil
\end{equation}

Sob Amostragem Estratificada **QUAL FÓRMULA???**: 

\begin{equation} \label{eq:n-estrat}
n = \Bigg\lceil \frac{1}{\frac{\delta^2}{z_{\gamma} \sum_{h=1}^H {W_h\hat{s}_h^2}} + \frac{1}{N}} \Bigg\rceil
\end{equation}

Ainda sob Amostragem Estratificada e tomando o menor inteiro maior que e expressção que determina $n_h$ para todo estrato, a Alocação Proporcional determina que 

\begin{equation} \label{eq:n-h-ap}
n_h = \lceil n W_h \rceil
\end{equation}

A Alocação Ótima de Neyman determina que 
\begin{equation} \label{eq:n-h-aon}
n_h = \Big\lceil n \frac{N_h \hat{s}_h}{\sum_{h=1}^H {N_h \hat{s}_h}}\Big\rceil
\end{equation}

