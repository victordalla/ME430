---
output: 
  pdf_document:
    template: template.tex 
    number_sections: true
bibliography: bibliography.bib
papersize: a4paper
fontsize: 11pt
documentclass: article
geometry: margin=2cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE,
                      tidy.opts = list(width.cutoff = 60),
                      tidy = TRUE)
options(OutDec = ",", 
        digits = 4, 
        knitr.table.format = "latex", 
        xtable.comment = FALSE)
```


\begin{titlepage} 

\begin{center} 
{\large Universidade Estadual de Campinas}\\[0.2cm] 
{\large Instituto de Matemática, Estatística e Computação Científica}\\[0.2cm] 
{\large Departamento de Estatística - ME430}\\[4cm]

{\bf \huge Trabalho de ME430}\\[6cm]


{\large Grupo}\\[0.2cm]
{\large Bragantini, J. - 170844, Nogueira, N. - 204186, Betini, L. - 201357, Cunha, V. - 206493}\\[0.2cm]
{\large Prof. Dr. Caio Azevedo}\\[6cm]

{\large Campinas}\\[0.2cm]
{\large 2018}
\end{center}

\end{titlepage}


# Questão 2 da Lista IV {-}

# Introdução

```{r lib}
library(readr)
library(dplyr)
library(tidyr)
library(magrittr)
library(ggplot2)
library(fastkendall)
library(psych)
```

```{r leitura}
questionario <- read_csv2('../dados/2017_quest.txt')
questionario$APROVA1 <- ifelse(is.na(questionario$APROVA1), 0, 1)
colnames(questionario)[1] <- 'EMPCT'

conv_matr <- read_csv2('../dados/ConvocadosMatriculados.csv')
conv_matr$CONVOCADO <- ifelse(is.na(conv_matr$CONVOCADO), 0, 1)
conv_matr$MATRICULADO <- ifelse(is.na(conv_matr$MATRICULADO), 0, 1)

fase1 <- read_csv2('../dados/Fase1TipoQ.csv', 
                   col_types = cols_only('EMPCT' = col_integer(), 
                                         'TOTAL' = col_integer()))

opcoes <- read_csv2('../dados/Opcoes.csv')

# DADOS DUPLICADOS 
conv_matr %<>% subset(!duplicated(conv_matr$EMPCT))

N <- nrow(fase1)
```

Este trabalho consiste na aplicação de técnicas aprendidas na disciplina ME430 - Técnicas de Amostragem - em um conjunto de dados da COMVEST. Esse conjunto de dados possui informações de `r N` candidatos ao vestibular 2017 e seus desempenhos nele. O objetivo é estimar i) a média da pontuação total de cada cadiadato, ii) a proporção de candidatos que cursaram todo o ensino médio em escola pública e iii) o total de quartos nas casas de todos os candidatos. 
A Seção \ref{s.descritiva} contém análises descritivas a nível populacional e obtidas por meio de amostras pilotos. A Seção \ref{s.inferencia} apresenta análises inferenciais, estimadores pontuais dos parâmetros de interesse e seus intervalos de confiança. Essas duas seções são dividas em três subseções cada, uma para cada parâmetro: *Média*, *Proporção* e *Total*, que se referem, respectivamente, aos parâmetros i), ii) e iii).


# Análise Descritiva
\label{s.descritiva}

Tratamos as análises realizas abaixos como indepentes visto que o âmbito de cada análise são diferentes.


## Média

```{r dados-media}
dados_media <- fase1 %>% left_join(questionario)

# 1: NA, 2: 5 SM ou menos, 3: entre 5 e 10 SM, 4: mais de 10 SM
dados_media$Q14[dados_media$Q14 == 0] <- 1
dados_media$Q14[dados_media$Q14 < 5 & dados_media$Q14 != 1] <- 2
dados_media$Q14[dados_media$Q14 == 5 | dados_media$Q14 == 6] <- 3
dados_media$Q14[dados_media$Q14 > 6] <- 4
```

```{r piloto-media}
# estratos
estratos <- quo(Q14)
N_h <- group_by(dados_media, !! estratos) %>% 
  summarise(N_h = n()) %>% 
  .$N_h
W_h <- N_h / N
H <- length(N_h)

# amostra piloto
n_piloto <- 200
piloto_media <- select(dados_media, EMPCT, TOTAL, !! estratos) %>% 
  group_by(!! estratos) %>% 
  mutate(N_h = n()) %>% 
  sample_frac(size = n_piloto/N, weight = N_h)

stats <- summarise(piloto_media, 
                   n_h = n(), 
                   mean_h = mean(TOTAL), 
                   var_h = var(TOTAL), 
                   sd_h = sd(TOTAL)) %>% 
  arrange(Q14)

mu_es <- sum(W_h * stats$mean_h)
var_d = sum(W_h * stats$var_h)
var_e = sum(W_h * (stats$mean_h - mu_es)^2)
var_chapeu <- var_d + var_e
```

```{r tamanho-media}
delta <- 1
gamma <- 0.975
z_gamma <- qnorm(gamma)

# tamanhos amostrais
n_AASs <- ceiling(1 / ((delta^2 / (z_gamma^2 * var_chapeu)) + (1/N)))

# Slide 18 http://www.ime.unicamp.br/~cnaber/aula_AE%20P2%20Amost%202S%202018.pdf
# n_AE_AP de acordo com a formula do jordão, slides estão incorretos
n_AE_AP <- ceiling(1 / ((delta^2 / (z_gamma^2 * sum(W_h^2*stats$var_h))) + (1/N))) 
n_h <- ceiling(n_AE_AP * (N_h*stats$sd_h) / sum(N_h*stats$sd_h))
n <- sum(n_h)
```


Inicialmente, para estimar $\mu$, a pontuação média de todos os candidatos na 1ª fase, foi coletada uma amostra piloto de tamanho `r n_piloto` sob uma amostragem estratificada (AE) com $H = `r H`$ estratos, especificados a seguir, a fim de determinar o tamanho amostral e o plano amostral mais adequado. Para isso, foi estimado a variância $\sigma_{\mu}^2 = \frac{1}{N} \sum_{i=1}^N y_i$ da pontuação e a variância nos estratos $\sigma_{\mu h}^2 = \frac{1}{N_h} \sum_{i=1}^{N_h} y_{ih}$, onde $N = `r N`$ é o número de candidatos, $N_h$ é o tamanho populacional do h-ésimo estrato, $y_i$ é a pontuação do i-ésimo candiadato e $y_{ih}$ é a pontuação do i-ésimo candidato no h-ésimo estrato. A alocação dos estratos foi feita segundo alocação proporcional (AP). Nesse tipo de alocação, o tamanho amostral do h-ésimo estrato é $n_h = n \frac{N_h}{N}$.

Os estratos escolhidos foram as respostas agrupadas da Questão 14 no questionário que cada candidato deveria responder. Essa questão é como segue: "Somando a sua renda com a renda das pessoas que moram com você, quanto é, aproximadamente, a renda familiar mensal? O valor do salário mínimo (SM) é de R$ 724,00". As respostas agrupadas determinam os seguintes estratos: 1 - dados faltantes, 2 - até 5 SM, 3 - entre 5 e 10 SM e 4 - mais que 10 SM.

A amostra piloto resultou em uma estimativa de $\hat{\sigma_{\mu}^2} = \hat{\sigma_d^2} + \hat{\sigma_e^2} = `r var_d + var_e`$ **(HELP WANTED)** para a variância $\sigma_{\mu}^2$, onde $\hat{\sigma_d^2} = \sum_{i=1}^H \frac{N_h}{N}\hat{\sigma_h^2}$ é a variância estimada no h-ésimo estrato e $\hat{\sigma_e^2} = \sum_{i=1}^H \frac{N_h}{N}(\hat{\mu}_h-\mu)^2$ é a variância estimada das médias dos estratos. 
De posse dessa informação, para realizar AE com AP e erro de estimativa $\delta = `r delta`$, é preciso um tamanho de amostra $n$ de pelo menos $n \geq \frac{z_{`r gamma`}^2}{\delta^2} \sum_{i=1}^H\frac{N_h}{N} \hat{\sigma^2}$ **(OU SERIA S^2 AQUI?)** para garantir que $P(|\mu - \hat{\mu}| \leq \delta) \geq `r gamma`$ \cite{bolfarine2005elementos}, onde $z_{`r gamma`}$ é o `r gamma`-quantil da normal padrão. Portanto, para os dados coletados, são necessárias pelo menos `r n_AE_AP` unidades amostrais.

Por outro lado, uma amostragem aleatória simples sem reposição (AASs) requer $\Big(\frac{\delta^2}{\hat{s^2}z_{`r gamma`}} + \frac{1}{N}\Big)^{-1}$ para garantir que $P(|\mu - \hat{\mu}| \leq \delta) \geq `r gamma`$ \cite{bolfarine2005elementos}, onde $s_{\mu}^2 = \frac{n\sigma^2}{n-1}$. Para os dados observados, esse plano amostral precisa de `r n_AASs` unidades amostrais, número maior que no caso AE com AP. Portanto, é mais vantajoso realizar AE com AP. 
É possível tornar a amostragem ainda mais robusta, utilizando a alocação ótima de Neyman (AON), que minimiza a variância da estimativa $\hat{\mu} = \sum$  para $\mu$ quando o custo de amostragem é homogêneo entre os estratos. Usando AON, temos que $n_h = n \frac{N_h\sigma_h}{\sum_{i=1}^HN_h\sigma_h}$ \cite{bolfarine2005elementos}. Como $\sigma_h$ não são valores conhecidos, foi usado $\hat{\sigma_h^2}$. As informações obtidas da amostra piloto e referentes à amostragem AE com AON estão resumidas na Tabela \ref{tab:resumo-media}. Observe que $n = `r n`$ tem `r n-n_AE_AP` unidades a mais sob AON, pelo fato de ter sido pego o menor inteiro maior que a expressão que determina $n_h$.

\begin{table}[!h]
\centering
\caption{Informações de cada estrato $h$: $N_h$ - número de cadidatos no estrato, $\hat{\sigma_h^2}$ - variância no estrato estimada na amostra piloto, $n_h$ - tamanho amostral do estrato segundo AON.}
\label{tab:resumo-media}
\fontsize{11}{13}\selectfont

\begin{tabular}{l|lll}
$h$ & $N_h$ & $\hat{\sigma_h^2}$ & $n_h$ \\
\hline
1 & `r N_h[1]` & `r stats$var_h[1]` & `r n_h[1]` \\
2 & `r N_h[2]` & `r stats$var_h[2]` & `r n_h[2]` \\
3 & `r N_h[3]` & `r stats$var_h[3]` & `r n_h[3]` \\
4 & `r N_h[4]` & `r stats$var_h[4]` & `r n_h[4]` \\
\end{tabular}
\end{table}


## Proporção
\label{ss.descr.prop}

```{r prop-descritiva}
cor_fund1_fund2 <- questionario %$% polychoric(table(.$Q2, .$Q3))$rho
```

A nível populacional, observa-se que existe uma correlação de `r cor_fund1_fund2` entre o setor (público ou privado) da escola de um candidato em um nível (Ensino Fundamental 1, Ensino Fundalmental 2 e Ensino Médio) ao nível subsequente. De encontro a essa informação, também se observa que alunos que estudaram o Ensino Fundamental 1 completamente em instituições públicas frequentaram o Ensino Fundamental 2 público numa proporção maior dos restantes dos indivíduos **APRESENTAR DADOS QUE CORROBOREM AFIRMAÇÂO**.

```{r plot-ens-fundamental}
questionario %>% mutate(estrato = (Q2 == 1),
                        pub = (Q3 == 1)) %>%
    ggplot(aes(pub)) + geom_bar() + facet_grid(. ~ estrato)
```


## Total

No banco de dados há informações sobre eletrônicos domésticos, cômodos das casas e da estrutura familiar dos inscritos no vestibular da COMVEST. Para estimar o total de quartos de uma casa, foi verificado se existe alguma ligação entre a quantidade de banheiro, número de pessoas dependentes da mesma renda familiar e quantidade de televisões na casa com o total de quartos da casa. Essas variáveis foram selecionados supondo-se que normalmente uma casa com muitos quartos possui mais banheiros, mais dependentes e a possibilidade de haverem televisões em cômodos diferentes da casa.

```{r total-exploratoria}

```


```{r total-descritiva}
smp <- sample_n(questionario, 200)

# smp %>% ggplot(aes(Q32D, Q32C, alpha = 0.2)) + 
#     geom_jitter() + xlab("# Banheiros") + ylab("# Quartos")

# Deve ser maior que 0.6
# UTILIZAR PACOTE PSYCH QUE O CAIO FALOU NA AULA
# smp %$% fastkendall(.$Q32D, .$Q32C)
# http://www.john-uebersax.com/stat/tetra.htm
# corr <- smp %$% polychoric(table(.$Q15, .$Q32C))$rho

# Deve ser entre 0.5 e 1.3
tmp <- (sd(smp$Q15) / mean(smp$Q15)) / (sd(smp$Q32C)/mean(smp$Q32C))

# Deve ser menor que rho(x, y)
tmp <- (sd(smp$Q15) / mean(smp$Q15)) / (2 * sd(smp$Q32C)/mean(smp$Q32C))

```


# Análise Inferencial
\label{s.inferencia}

## Média


## Proporção

Conforme observado na Subseção \ref{ss.descr.prop} há uma tendência de os alunos se manterem no mesmo setor do ensino ao avançar nos níveis de educação antes de entrar no ensino superior. Assim dividiremos nossa população em dois estratos: 1 - candidatos que cursaram o Ensino Fundamental 1 por completo em escolas públicas e 2 - candidatos restantes.

```{r prop-inf-piloto}
# Proporcao de alunos de escola pública
pub <- questionario[questionario$Q3 == 1, ]$EMPCT
priv <- questionario[questionario$Q3 != 1, ]$EMPCT

N_h <- c(length(pub), length(priv))
N <- nrow(questionario)
W_h <- N_h / N
H <- 2 # quantidade de estratos

# Amostra piloto 
n_h_piloto <- ceiling(W_h * n_piloto) # estrato proporcional

n_pil_final <- sum(n_h_piloto)

amostra_pil_1 <- sample_n(questionario %>% filter(EMPCT %in% pub), n_h_piloto[1])
amostra_pil_2 <- sample_n(questionario %>% filter(EMPCT %in% priv), n_h_piloto[2])

p_piloto <- c(sum(amostra_pil_1$Q4 == 1) / nrow(amostra_pil_1),
              sum(amostra_pil_2$Q4 == 1) / nrow(amostra_pil_2))

s2hat_pil <- n_h_piloto / (n_h_piloto - 1) * p_piloto * (1 - p_piloto)

varhat_phat_pil <- (1 - n_h_piloto/N) * s2hat_pil / n_h_piloto

# DÚVIDA SE REALMENTE É ASSIM COMO CALCULA VARIANCIA ENTRE ESTRATO PARA PROPORCAO
p_est_piloto <- sum(p_piloto * W_h)
s2hat_e <- sum(W_h * (p_piloto - p_est_piloto)^2)
s2hat_d <- sum(W_h * s2hat_pil)
```

Sob essa estratificação, selecionamos uma amostra piloto de tamanho `r n_pil_final`, onde cada estrato foi amostrado com um tamanho proporcional a sua população e verificamos se o comportamento de se manter no mesmo setor do ensino quando se passa do Ensino Fundamental 2 para o Ensino Médio é similar ao do observado na Subseção \ref{ss.descr.prop}.

Na Tabela \ref{tab:piloto-prop} apresentamos as estatísticas da nossa amostra piloto. Utilizando essas informações, vemos que a variância dentro dos estratos, $\hat{s_d^2} = `r s2hat_d`$ é consideravelmente menor que a estimativa da variância da amostra, $\hat{s^2} = \hat{s_d^2} + \hat{s_d^2} = `r s2hat_d + s2hat_e`$.

\begin{table}[!h]
\centering
\caption{Informações de cada estrato $h$ para amostra piloto: $\hat{p}_h$ - proporção de canditatos estudaram o ensino medio completo em escolas públicas, $N_h$ - número de cadidatos no estrato, $\hat{s^2_h}$ - variância no estrato estimada na amostra piloto, $n_h$ - tamanho amostral do estrato.}
\label{tab:piloto-prop}
\fontsize{11}{13}\selectfont

\begin{tabular}{l|llll}
$h$ & $N_h$ & $\hat{p}_h$ & $\hat{s_h^2}$  & $n_h$ \\
\hline

1 & `r N_h[1]` & `r p_piloto[1]` & `r s2hat_pil[1]` & `r n_h_piloto[1]` \\
2 & `r N_h[2]` & `r p_piloto[2]` & `r s2hat_pil[2]` & `r n_h_piloto[2]` \\
\end{tabular}
\end{table}

```{r prop-inf}
# Tamanhos amostrais

delta <- 0.01 # erro de estimação DUVIDA!!!
gamma <- 0.975
z_gamma <- qnorm(gamma)
n <- ceiling(1 / (delta^2/(z_gamma^2 * sum(W_h^2 * s2hat_pil)) + 1/N))

n_h <- ceiling(n * N_h * sqrt(s2hat_pil) / sum(N_h * sqrt(s2hat_pil)))

# Amostragem final

amostra_1 <- sample_n(questionario %>% filter(EMPCT %in% pub), n_h[1])
amostra_2 <- sample_n(questionario %>% filter(EMPCT %in% priv), n_h[2])

phat_h <- c(sum(amostra_1$Q4 == 1) / dim(amostra_1)[1],
            sum(amostra_2$Q4 == 1) / dim(amostra_2)[1])

phat <- sum(W_h * phat_h)

s2hat <- n_h / (n_h - 1) * phat_h * (1 - phat_h)

varhat_phat <- (1 - n_h_piloto/N) * s2hat / n_h_piloto

s2hat_e <- sum(W_h * (p_piloto - p_est_piloto)^2)
s2hat_d <- sum(W_h * s2hat_pil)
```

Com as estatísticas obtidas da amostra piloto estabelecemos nossa margem de erro desejada, $\delta = `r delta`$, e nosso intervalo de confiança desejado, $\gamma = `r gamma`$, assim conforme a Equação \ref{eq:n-prop-estrat} apresentada no Apêndice, obtemos o tamanho amostral $n = `r n`$. 

Uma vez definido o tamanho da amostra definimos o tamanho de cada estrato utilizando a Alocação Ótima de Neyman, Equação \ref{eq:aon-estrat} vide Apêndice, dado isso obtemos nossa amostra, **... continuar blah blah blah**

\begin{table}[!h]
\centering
\caption{Informações de cada estrato $h$: $\hat{p}_h$ - proporção de canditatos estudaram o ensino medio completo em escolas públicas, $N_h$ - número de cadidatos no estrato, $\hat{s^2_h}$ - variância no estrato estimada na amostra piloto, $n_h$ - tamanho amostral do estrato.}
\label{tab:piloto-prop}
\fontsize{11}{13}\selectfont

\begin{tabular}{l|lllll}
$h$ & $N_h$ & $\hat{p}_h$ & $\hat{Var(\hat{p_h})}$ & $\hat{s_h^2}$  & $n_h$ \\
\hline

1 & `r N_h[1]` & `r phat_h[1]` & `r format(varhat_phat[1], digits=4)` & `r s2hat[1]` & `r n_h[1]` \\
2 & `r N_h[2]` & `r phat_h[2]` & `r format(varhat_phat[2], digits=4)` & `r s2hat[2]` & `r n_h[2]` \\
\end{tabular}
\end{table}

## Total

# Conclusões

\bibliographystyle{plain}
\bibliography{bibliography}

# Apêndice {-}

Descrição das equacoes blabh blah

Equação para tamanho amostral dado uma amostra estratifica sem reposição:

$$ n = \Bigg\lceil\frac{1}{\frac{\delta^2}{z_{\gamma/2} \sum_{h=1}^H {W_h^2\hat{s_h^2}}} + \frac{1}{N}}\Bigg\rceil $$
\label{eq:n-prop-estrat}

Adicionar comentários sobre esta formula (aloc otima de neyney)

<!-- n_h <- ceiling(n * N_h * sqrt(s2hat_pil) / sum(N_h * sqrt(s2hat_pil))) -->

$$ n_h = \Big\lceil n \frac{N_h \hat{s}_h}{\sum_{h=1}^H {N_h \hat{s}_h}}\Big\rceil $$
\label{eq:aon-estrat}
